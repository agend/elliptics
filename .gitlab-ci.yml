# This file is generated by GitLab CI
centos6:
  script:
  - git submodule update --init
  - rm -rf deps
  - mkdir deps
  - wget http://gitlab.loc/snippets/13/raw -O ./deps/elliptics-nococain.patch
  - dos2unix ./deps/elliptics-nococain.patch
  - "# add new line to the end of file"
  - sed -i -e '$a\' ./deps/elliptics-nococain.patch
  - git apply ./deps/elliptics-nococain.patch
  - VERSION=`grep Version elliptics-bf.spec | awk -F "\t" '{print $2}'`
  - echo '${VERSION}'
  - eblob_ver=`grep "BuildRequires:.*blob-devel" elliptics-bf.spec | awk -F '>= '
    '{print $2}'`
  - scp distro@gitlab.loc:~/elliptics/deps/el6/* deps/
  - scp distro@gitlab.loc:~/elliptics/el6/eblob* deps/
  - yum localinstall -y deps/*el6*.rpm
  - cur_dir_name=${PWD##*/}
  - mkdir -p ./rpmbuild/{SOURCES,BUILD,RPMS,SPECS,SRPMS}
  - mkdir -p ./rpmbuild/RPMS/x86-64
  - tar cjf ./rpmbuild/SOURCES/elliptics-${VERSION}.tar.bz2 ../${cur_dir_name} --exclude=rpmbuild
    --exclude=deps --transform s/${cur_dir_name}/elliptics-${VERSION}/
  - rpmbuild -ba --define "_topdir ${PWD}/rpmbuild" elliptics-bf.spec
  - scp ./rpmbuild/RPMS/x86_64/* distro@gitlab.loc:~/elliptics/el6/
  tags:
  - centos6
  except:
  - tags
  - master
centos7:
  script:
  - git submodule update --init
  - mkdir deps
  - wget http://gitlab.loc/snippets/13/raw -O ./deps/elliptics-nococain.patch
  - dos2unix ./deps/elliptics-nococain.patch
  - "# add new line to the end of file"
  - sed -i -e '$a\' ./deps/elliptics-nococain.patch
  - git apply ./deps/elliptics-nococain.patch
  - VERSION=`grep Version elliptics-bf.spec | awk -F "\t" '{print $2}'`
  - echo '${VERSION}'
  - eblob_ver=`grep "BuildRequires:.*blob-devel" elliptics-bf.spec | awk -F '>= '
    '{print $2}'`
  - scp distro@gitlab.loc:~/elliptics/deps/el7/* deps/
  - scp distro@gitlab.loc:~/elliptics/el7/eblob* deps/
  - yum localinstall -y deps/*el7*.rpm
  - cur_dir_name=${PWD##*/}
  - mkdir -p ./rpmbuild/{SOURCES,BUILD,RPMS,SPECS,SRPMS}
  - mkdir -p ./rpmbuild/RPMS/x86-64
  - tar cjf ./rpmbuild/SOURCES/elliptics-${VERSION}.tar.bz2 ../${cur_dir_name} --exclude=rpmbuild
    --exclude=deps --transform s/${cur_dir_name}/elliptics-${VERSION}/
  - rpmbuild -ba --define "_topdir ${PWD}/rpmbuild" elliptics-bf.spec
  - scp ./rpmbuild/RPMS/x86_64/* distro@gitlab.loc:~/elliptics/el7/
  tags:
  - centos7
  except:
  - tags
  - master
